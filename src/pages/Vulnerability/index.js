import React, { Component } from 'react';
import PropTypes from 'prop-types';
import { connect } from 'react-redux';
import { withRouter } from 'react-router-dom';
import _ from 'lodash';
import { Table, Segment, Header } from 'semantic-ui-react';

import { FETCH_VULNERABILITY_BY_ID } from '../../actions/vulnerability';

class Vulnerability extends Component {
  constructor(props) {
    super(props);

    const { match } = props;
    let vuln = null;
    props.vulnerabilityList.forEach((vulnItem) => {
      if (vulnItem.id === parseInt(match.params.id, 10)) {
        vuln = _.cloneDeep(vulnItem);
      }
    });

    console.log(props);

    this.state = {
      id: match.params.id,
      vuln,
    };
  }

  componentWillMount = () => {
    this.props.fetchVulnerabilityByID(this.state.id);
  }

  coponentWillReceiveProps = (nextProps) => {
    console.log('props');
    console.log(nextProps);
    if (!this.state.vuln) {
      nextProps.vulnerabilityList.forEach((vuln) => {
        if (vuln.id === this.state.id) {
          this.setState({ ...this.state, vuln });
        }
      });
    }
  }

  renderVulnInfo = () => {
    if (!this.state.vuln) return null;
    const style = {
      tableCell: {
        padding: '5px',
        fontSize: '12px',
      },
    };
    const info = [
      {
        fieldName: 'ID',
        value: this.state.vuln.id,
        key: 'id',
      },
      {
        fieldName: 'Title',
        value: this.state.vuln.title,
        key: 'title',
      },
      {
        fieldName: 'Summary',
        value: this.state.vuln.summary,
        key: 'summary',
      },
      {
        fieldName: 'Impact',
        value: this.state.vuln.impact,
        key: 'impact',
      },
      {
        fieldName: 'Solution',
        value: this.state.vuln.solution,
        key: 'solution',
      },
      {
        fieldName: 'cvss_score',
        value: this.state.vuln.cvss_score,
        key: 'cvss_score',
      },
      {
        fieldName: 'Risk Factor',
        value: this.state.vuln.risk_factor,
        key: 'risk_factor',
      },
      {
        fieldName: 'Exploitable',
        value: this.state.vuln.exploitable,
        key: 'exploitable',
      },
      {
        fieldName: 'Output',
        value: this.state.vuln.output,
        key: 'output',
      },
      {
        fieldName: 'Category',
        value: this.state.vuln.category,
        key: 'category',
      },
      {
        fieldName: 'Exploit-DB ID',
        value: this.state.vuln.edb_id,
        key: 'edb_id',
      },
      {
        fieldName: 'Metasploit package name',
        value: this.state.vuln.metasploit_name,
        key: 'metasploit_name',
      },
      {
        fieldName: 'Exploit Framework Metasploit',
        value: this.state.vuln.exploit_framework_metasploit,
        key: 'exploit_framework_metasploit',
      },
      {
        fieldName: 'Exploit Framework Core',
        value: this.state.vuln.exploit_framework_core,
        key: 'exploit_framework_core',
      },
      {
        fieldName: 'Exploit Framework Canvas',
        value: this.state.vuln.exploit_framework_canvas,
        key: 'exploit_framework_canvas',
      },
      {
        fieldName: 'Vulnerability Publication Date',
        value: this.state.vuln.vuln_publication_date,
        key: 'vuln_publication_date',
      },
      {
        fieldName: 'Vulnerability ID',
        value: this.state.vuln.vid,
        key: 'vid',
      },
      {
        fieldName: 'CVE',
        value: this.state.vuln.cve,
        key: 'cve',
      },
    ];

    return _.map(info, (field) => {
      const { fieldName, value } = field;
      const fieldValue = typeof value === 'string' ?
        value.split('\n').map((str, i) => (<span key={str.concat(i)}>{str}<br /></span>)) : value;
      return (
        <Table.Row style={field.key === 'id' ? { backgroundColor: '#c6c6c6' } : {}} key={field.key}>
          <Table.Cell
            disabled={!value && value !== 0}
            singleLine
            style={style.tableCell}
          >
            <b>{fieldName}</b>
          </Table.Cell>
          <Table.Cell
            disabled={!value && value !== 0}
            style={style.tableCell}
          >
            {fieldValue}
          </Table.Cell>
        </Table.Row>
      );
    });
  }

  render() {
    if (!this.state.vuln) return null;
    const RED = '#da1c15';
    const YELLOW = '#f6ad26';
    const GREEN = '#7db346';
    const BLUE = '#5280fb';
    const colorCodes = [BLUE, GREEN, YELLOW, RED];
    const vulnerabilityColorCode = colorCodes[this.state.vuln.risk_factor];
    const textColor = vulnerabilityColorCode === RED ? '#f8f8f2' : '#000000';

    const style = {
      header: {
        color: textColor,
        backgroundColor: vulnerabilityColorCode,
        border: `1px solid${vulnerabilityColorCode}`,
        fill: vulnerabilityColorCode,
      },
      segment: {
        border: `1px solid${vulnerabilityColorCode}`,
        padding: '8px',
      },
      tableCell: {
        padding: '5px',
      },
    };

    return (
      <div>
        <Header style={style.header} attached='top'>Vulnerability</Header>
        <Segment style={style.segment} attached>
          <Table celled striped selectable>
            <Table.Body>
              {this.renderVulnInfo()}
            </Table.Body>
          </Table>
        </Segment>
      </div>
    );
  }
}

Vulnerability.propTypes = {
  match: PropTypes.shape({
    params: PropTypes.shape({
      id: PropTypes.string.isRequired,
    }).isRequired,
  }).isRequired,
  fetchVulnerabilityByID: PropTypes.func.isRequired,
};

const mapDispatchToProps = dispatch => ({
  fetchVulnerabilityByID: id => dispatch(FETCH_VULNERABILITY_BY_ID(id)),
});

const mapStateToProps = (state, ownProps) => {
  const { id } = ownProps.match.params;
  let vuln = null;
  state.audits.vulnerabilityList.forEach((vulnEntry) => {
    if (vulnEntry.id === parseInt(id, 10)) {
      vuln = vulnEntry;
    }
  });
  return ({
    vulnerabilityList: state.audits.vulnerabilityList,
    vuln,
    fetchError: state.audits.vulnStatus.fetchError,
    fetchLoading: state.audits.vulnStatus.fetchLoading,
  });
};

export default connect(mapStateToProps, mapDispatchToProps)(withRouter(Vulnerability));
